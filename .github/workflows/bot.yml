name: ğŸ›¡ï¸ Iran-USA-Israel War Bot v18

on:
  schedule:
    # GitHub Actions minimum = */5 â€” Ú©Ù…ØªØ± Ø§Ø² Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡ Ø§Ø¬Ø±Ø§ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯
    # Ø¯Ø± Ø¹Ù…Ù„ Ù‡Ø± Ûµ-Û±Û° Ø¯Ù‚ÛŒÙ‚Ù‡ Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯ (Ø¨Ø§ ØªØ£Ø®ÛŒØ± Ø§Ø­ØªÙ…Ø§Ù„ÛŒ GitHub)
    - cron: '*/5 * * * *'
  workflow_dispatch:

# Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø¬Ø±Ø§ÛŒ Ù…ÙˆØ§Ø²ÛŒ â€” Ø§Ú¯Ù‡ run Ù‚Ø¨Ù„ÛŒ Ù‡Ù†ÙˆØ² ØªÙ…Ø§Ù… Ù†Ø´Ø¯Ù‡ Ù…Ù†ØªØ¸Ø± Ø¨Ù…Ø§Ù†Ø¯
concurrency:
  group: warbot-run
  cancel-in-progress: false

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 8    # Ø§ÙØ²Ø§ÛŒØ´ Ø§Ø² Û´ Ø¨Ù‡ Û¸ Ø¯Ù‚ÛŒÙ‚Ù‡ â€” Ø¨Ø±Ø§ÛŒ ØªØ±Ø¬Ù…Ù‡ Ùˆ fetch ØªØµÙˆÛŒØ±
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --quiet \
            feedparser \
            httpx \
            "httpx[http2]" \
            beautifulsoup4 \
            pytz \
            lxml \
            hazm \
            "Pillow>=9.0.0"

      - name: Run War Bot
        env:
          BOT_TOKEN:      ${{ secrets.BOT_TOKEN }}
          CHANNEL_ID:     ${{ secrets.CHANNEL_ID }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: python bot.py

      - name: Commit state files
        if: always()
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add \
            seen.json \
            stories.json \
            run_state.json \
            nitter_cache.json \
            gemini_state.json \
            flight_alerts.json \
            2>/dev/null || true
          git diff --staged --quiet || \
            (git commit -m "â™»ï¸ state [skip ci]" && git push)
