name: ğŸ›¡ï¸ WarBot v19 â€” Iran/USA/Israel (Ù¾ÛŒÙˆØ³ØªÙ‡ Û¶ Ø³Ø§Ø¹Øª)

on:
  schedule:
    # Ù‡Ø± Û¶ Ø³Ø§Ø¹Øª ÛŒÚ© Ø¨Ø§Ø± Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯ â€” bot Ø®ÙˆØ¯Ø´ Ø¯Ø§Ø®Ù„ Û³ÛµÛ° Ø¯Ù‚ÛŒÙ‚Ù‡ loop Ù…ÛŒâ€ŒØ²Ù†Ø¯
    # Ù†ØªÛŒØ¬Ù‡: Ù¾ÙˆØ´Ø´ Û²Û´/Û· Ø¨Ø¯ÙˆÙ† ÙˆÙ‚ÙÙ‡
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual run'
        required: false
        default: 'manual'

# ÙÙ‚Ø· ÛŒÚ© instance Ø¯Ø± Ù‡Ø± Ù„Ø­Ø¸Ù‡ â€” Ø§Ø¬Ø±Ø§ÛŒ Ù…ÙˆØ§Ø²ÛŒ Ù…Ù…Ù†ÙˆØ¹
concurrency:
  group: warbot-single
  cancel-in-progress: false

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 360     # Û¶ Ø³Ø§Ø¹Øª â€” bot Ø¨Ø¹Ø¯ Ø§Ø² Û³ÛµÛ° Ø¯Ù‚ÛŒÙ‚Ù‡ Ø®ÙˆØ¯Ø´ Ø®Ø§Ø±Ø¬ Ù…ÛŒâ€ŒØ´ÙˆØ¯
    permissions:
      contents: write

    env:
      BOT_TOKEN:      ${{ secrets.BOT_TOKEN }}
      CHANNEL_ID:     ${{ secrets.CHANNEL_ID }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      CI: "true"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --quiet \
            feedparser \
            httpx "httpx[http2]" \
            beautifulsoup4 \
            pytz \
            lxml \
            hazm \
            "Pillow>=9.0.0"

      - name: Run WarBot (Ù¾ÛŒÙˆØ³ØªÙ‡ - Ù‡Ø± Û´Ûµ Ø«Ø§Ù†ÛŒÙ‡ ÛŒÚ© Ú†Ø±Ø®Ù‡)
        run: python bot.py

      - name: Save state files
        if: always()
        run: |
          git config --global user.name  "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add \
            seen.json \
            stories.json \
            run_state.json \
            nitter_cache.json \
            gemini_state.json \
            2>/dev/null || true
          git diff --staged --quiet || \
            (git commit -m "â™»ï¸ state [skip ci]" && git push)
