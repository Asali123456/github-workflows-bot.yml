name: ğŸ›¡ï¸ Iran-USA-Israel War Bot v15

on:
  schedule:
    - cron: '*/2 * * * *'    # Ù‡Ø± Û² Ø¯Ù‚ÛŒÙ‚Ù‡ â†’ Ø§ÙˆÙ„ÛŒÙ† Ù†ÙØ±
  workflow_dispatch:

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 4
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1      # Ø³Ø±ÛŒØ¹â€ŒØªØ± â€” ÙÙ‚Ø· Ø¢Ø®Ø±ÛŒÙ† commit

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'        # Ú©Ø´ â†’ Ù†ØµØ¨ Ù…Ø¬Ø¯Ø¯ Ù†ÛŒØ§Ø² Ù†ÛŒØ³Øª

      - name: Install dependencies
        run: |
          pip install --quiet \
            feedparser \
            "httpx[http2]" \
            beautifulsoup4 \
            pytz \
            lxml \
            hazm \
            "Pillow>=9.0.0"

      - name: Run War Bot
        env:
          BOT_TOKEN:      ${{ secrets.BOT_TOKEN }}
          CHANNEL_ID:     ${{ secrets.CHANNEL_ID }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: python bot.py

      - name: Commit state files
        if: always()
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add \
            seen.json \
            stories.json \
            run_state.json \
            nitter_cache.json \
            gemini_state.json \
            flight_alerts.json \
            2>/dev/null || true
          git diff --staged --quiet || \
            (git commit -m "â™»ï¸ state [skip ci]" && git push)
